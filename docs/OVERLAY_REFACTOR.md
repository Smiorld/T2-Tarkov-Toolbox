# æ‚¬æµ®çª—é‡æ„ï¼šä½¿ç”¨MapCanvas

## é—®é¢˜

ä¹‹å‰çš„æ‚¬æµ®çª—å®ç°å­˜åœ¨ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼š

1. **æ¯æ¬¡æ‹–æ‹½/ç¼©æ”¾éƒ½é‡æ–°resizeå›¾ç‰‡** - éå¸¸æ¶ˆè€—CPU
2. **æ²¡æœ‰å›¾ç‰‡ç¼“å­˜** - ä¸»Canvasæœ‰ç¼“å­˜ï¼Œæ‚¬æµ®çª—æ²¡æœ‰
3. **é‡å¤å®ç°æ¸²æŸ“é€»è¾‘** - ç»´æŠ¤ä¸¤å¥—åæ ‡è½¬æ¢ä»£ç 
4. **å®¹æ˜“å‡ºé”™** - é”šç‚¹ä¸åŒ¹é…ã€offsetè®¡ç®—é”™è¯¯ç­‰

## è§£å†³æ–¹æ¡ˆ

**ç›´æ¥å¤ç”¨MapCanvasç±»**ï¼

### ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ

MapCanvaså·²ç»å®ç°äº†ï¼š
- âœ… å›¾ç‰‡ç¼“å­˜ï¼ˆ`_get_cached_photo()`ï¼‰
- âœ… ä¼˜åŒ–çš„æ¸²æŸ“ï¼ˆ`_render()`ï¼‰
- âœ… æµç•…çš„æ‹–æ‹½å’Œç¼©æ”¾
- âœ… æ­£ç¡®çš„åæ ‡è½¬æ¢ï¼ˆ`_map_to_canvas_coords()`ï¼‰
- âœ… ç©å®¶æ ‡è®°ç»˜åˆ¶ï¼ˆ`show_player_position()`ï¼‰

### æ–°çš„æ¶æ„

**æ—§ç‰ˆæœ¬**ï¼š
```
OverlayWindow
â”œâ”€â”€ Canvas (tkinteråŸç”Ÿ)
â”œâ”€â”€ è‡ªå·±çš„æ¸²æŸ“é€»è¾‘
â”œâ”€â”€ è‡ªå·±çš„åæ ‡è½¬æ¢
â””â”€â”€ è‡ªå·±çš„ç¼“å­˜ï¼ˆæ— ï¼‰
```

**æ–°ç‰ˆæœ¬**ï¼š
```
OverlayWindow
â”œâ”€â”€ MapCanvas (å¤ç”¨)
â”‚   â”œâ”€â”€ Canvas
â”‚   â”œâ”€â”€ å›¾ç‰‡ç¼“å­˜
â”‚   â”œâ”€â”€ ä¼˜åŒ–çš„æ¸²æŸ“
â”‚   â””â”€â”€ åæ ‡è½¬æ¢
â””â”€â”€ ç©å®¶å±…ä¸­é€»è¾‘
```

## å®ç°ç»†èŠ‚

### ä½¿ç”¨MapCanvas

```python
class OverlayMapWindow(ctk.CTkToplevel):
    def _setup_ui(self):
        # ä½¿ç”¨MapCanvasï¼ˆå¤ç”¨ä¸»UIçš„åœ°å›¾æ¸²æŸ“é€»è¾‘ï¼‰
        self.map_canvas = MapCanvas(
            self.container,
            width=self.window_width - 4,
            height=self.window_height - 4
        )
        self.map_canvas.pack(fill="both", expand=True)

        # ç¦ç”¨ç‚¹å‡»å›è°ƒï¼ˆæ‚¬æµ®çª—ä¸éœ€è¦æ ¡å‡†åŠŸèƒ½ï¼‰
        self.map_canvas.set_click_callback(None)
```

### ç©å®¶å±…ä¸­æ¨¡å¼

ç”±äºMapCanvasä¸æ”¯æŒè‡ªåŠ¨å±…ä¸­ï¼Œæˆ‘ä»¬åœ¨æ‚¬æµ®çª—å±‚å®ç°ï¼š

```python
def _update_player_centering(self):
    """æ›´æ–°ç©å®¶å±…ä¸­ï¼ˆå®šæ—¶è°ƒç”¨ï¼‰"""
    if not self.player_centered or self._player_map_x is None:
        return

    canvas_width = self.map_canvas.canvas_width
    canvas_height = self.map_canvas.canvas_height

    if self.map_canvas.map_image:
        img_width, img_height = self.map_canvas.map_image.size
        zoom = self.map_canvas.zoom

        # è®¡ç®—ç©å®¶ç›¸å¯¹äºåœ°å›¾ä¸­å¿ƒçš„åç§»
        player_dx = (self._player_map_x - img_width / 2) * zoom
        player_dy = (self._player_map_y - img_height / 2) * zoom

        # è®¾ç½®offsetä½¿ç©å®¶åœ¨Canvasä¸­å¿ƒ
        self.map_canvas.offset_x = canvas_width / 2 - player_dx
        self.map_canvas.offset_y = canvas_height / 2 - player_dy

        # è§¦å‘é‡ç»˜
        self.map_canvas._render()

    # ç»§ç»­è·Ÿéšï¼ˆæ¯100msæ›´æ–°ä¸€æ¬¡ï¼‰
    if self.player_centered:
        self._auto_follow_timer = self.after(100, self._update_player_centering)
```

### æ›´æ–°ç©å®¶ä½ç½®

```python
def update_player_position(self, map_x: float, map_y: float, yaw: Optional[float] = None):
    """æ›´æ–°ç©å®¶ä½ç½®"""
    self._player_map_x = map_x
    self._player_map_y = map_y
    self._player_yaw = yaw

    # ä½¿ç”¨MapCanvasçš„æ–¹æ³•æ˜¾ç¤ºç©å®¶
    self.map_canvas.show_player_position(map_x, map_y, yaw or 0.0)

    # å¦‚æœæ˜¯å±…ä¸­æ¨¡å¼ï¼Œç«‹å³æ›´æ–°å±…ä¸­
    if self.player_centered:
        self._update_player_centering()
```

## æ€§èƒ½å¯¹æ¯”

### æ—§ç‰ˆæœ¬
- æ‹–æ‹½ï¼šæ¯æ¬¡ç§»åŠ¨éƒ½resizeå›¾ç‰‡ â†’ **å¡é¡¿**
- ç¼©æ”¾ï¼šæ¯æ¬¡zooméƒ½resizeå›¾ç‰‡ â†’ **å¡é¡¿**
- å†…å­˜ï¼šæ²¡æœ‰ç¼“å­˜ï¼Œé¢‘ç¹åˆ›å»ºé”€æ¯å›¾ç‰‡å¯¹è±¡

### æ–°ç‰ˆæœ¬
- æ‹–æ‹½ï¼šMapCanvasçš„ä¼˜åŒ–æ‹–æ‹½ï¼ˆ`canvas.move()`ï¼‰ â†’ **æµç•…**
- ç¼©æ”¾ï¼šä½¿ç”¨ç¼“å­˜çš„å›¾ç‰‡ â†’ **æµç•…**
- å†…å­˜ï¼šç¼“å­˜å¤šä¸ªzoomçº§åˆ«çš„å›¾ç‰‡

## ä»£ç ç®€åŒ–

### æ—§ç‰ˆæœ¬ï¼ˆ~530è¡Œï¼‰
- è‡ªå·±å®ç°åœ°å›¾æ¸²æŸ“
- è‡ªå·±å®ç°åæ ‡è½¬æ¢
- è‡ªå·±å®ç°ç©å®¶æ ‡è®°ç»˜åˆ¶
- è‡ªå·±å¤„ç†ç¼©æ”¾å’Œæ‹–æ‹½

### æ–°ç‰ˆæœ¬ï¼ˆ~380è¡Œï¼‰
- å¤ç”¨MapCanvasçš„æ‰€æœ‰åŠŸèƒ½
- åªéœ€å®ç°çª—å£ç®¡ç†å’Œç©å®¶å±…ä¸­
- **å‡å°‘150è¡Œä»£ç **
- **æ¶ˆé™¤é‡å¤é€»è¾‘**

## ä¼˜åŠ¿

1. âœ… **æ€§èƒ½ä¼˜å¼‚** - å¤ç”¨MapCanvasçš„æ‰€æœ‰ä¼˜åŒ–
2. âœ… **ä»£ç ç®€æ´** - å‡å°‘150è¡Œä»£ç 
3. âœ… **è¡Œä¸ºä¸€è‡´** - ä¸»Canvaså’Œæ‚¬æµ®çª—å®Œå…¨ç›¸åŒçš„æ¸²æŸ“
4. âœ… **æ˜“äºç»´æŠ¤** - åªç»´æŠ¤ä¸€å¥—æ¸²æŸ“é€»è¾‘
5. âœ… **è‡ªåŠ¨ä¿®å¤** - MapCanvasçš„ä»»ä½•æ”¹è¿›éƒ½è‡ªåŠ¨åº”ç”¨åˆ°æ‚¬æµ®çª—

## åŠŸèƒ½å®Œæ•´æ€§

- âœ… å³é”®æ‹–æ‹½çª—å£
- âœ… å³é”®æ‹–æ‹½è¾¹ç¼˜è°ƒæ•´å¤§å°
- âœ… é”å®š/è§£é”ï¼ˆé¼ æ ‡ç©¿é€ï¼‰
- âœ… ç©å®¶å±…ä¸­æ¨¡å¼
- âœ… è‡ªç”±è§†å›¾æ¨¡å¼ï¼ˆMapCanvaså†…ç½®æ‹–æ‹½ï¼‰
- âœ… ç¼©æ”¾ï¼ˆMapCanvaså†…ç½®æ»šè½®ç¼©æ”¾ï¼‰
- âœ… é€æ˜åº¦è°ƒæ•´
- âœ… çŠ¶æ€ä¿å­˜/åŠ è½½

## æµ‹è¯•è¦ç‚¹

1. **æ€§èƒ½æµ‹è¯•**
   - æ‹–æ‹½åœ°å›¾å†…å®¹ï¼šåº”è¯¥æµç•…
   - æ»šè½®ç¼©æ”¾ï¼šåº”è¯¥æµç•…
   - æ‹–æ‹½çª—å£ï¼šåº”è¯¥æµç•…

2. **åŠŸèƒ½æµ‹è¯•**
   - ç©å®¶å±…ä¸­ï¼šç©å®¶åº”å§‹ç»ˆåœ¨çª—å£ä¸­å¿ƒ
   - å·¦é”®æ‹–æ‹½åœ°å›¾ï¼šåº”é€€å‡ºç©å®¶å±…ä¸­ï¼ˆMapCanvasè¡Œä¸ºï¼‰
   - ä½ç½®ä¸€è‡´æ€§ï¼šæ‚¬æµ®çª—å’Œä¸»Canvasæ˜¾ç¤ºç›¸åŒä½ç½®

3. **è¾¹ç¼˜æƒ…å†µ**
   - åœ°å›¾è¾¹ç¼˜ï¼šåº”æ­£ç¡®æ˜¾ç¤º
   - æç«¯ç¼©æ”¾ï¼š0.1x - 5.0xéƒ½åº”æ­£å¸¸
   - çª—å£è°ƒæ•´å¤§å°ï¼šåœ°å›¾åº”é€‚åº”æ–°å°ºå¯¸

## æ³¨æ„äº‹é¡¹

### å·¦é”®è¡Œä¸º

MapCanvasé»˜è®¤æ”¯æŒå·¦é”®æ‹–æ‹½åœ°å›¾ã€‚åœ¨æ‚¬æµ®çª—ä¸­ï¼š
- **è§£é”çŠ¶æ€**ï¼šå·¦é”®æ‹–æ‹½åœ°å›¾å†…å®¹ï¼ˆMapCanvasè¡Œä¸ºï¼‰
- **é”å®šçŠ¶æ€**ï¼šé¼ æ ‡ç©¿é€ï¼Œå·¦é”®æ— æ•ˆ

è¿™ä¸ä¹‹å‰çš„è®¾è®¡ä¸€è‡´ã€‚

### ç©å®¶å±…ä¸­çš„é€€å‡º

ç”±äºä½¿ç”¨MapCanvasï¼Œå½“ç”¨æˆ·å·¦é”®æ‹–æ‹½åœ°å›¾æ—¶ï¼ŒMapCanvasä¼šæ”¹å˜offsetã€‚

æ‚¬æµ®çª—é€šè¿‡å®šæ—¶å™¨ï¼ˆ100msï¼‰æŒç»­æ›´æ–°offsetæ¥ä¿æŒç©å®¶å±…ä¸­ã€‚

å¦‚æœéœ€è¦å®ç°"æ‹–æ‹½åœ°å›¾è‡ªåŠ¨é€€å‡ºå±…ä¸­"ï¼Œå¯ä»¥ç›‘å¬MapCanvasçš„æ‹–æ‹½äº‹ä»¶ã€‚

## æ–‡ä»¶å˜æ›´

- **æ–°æ–‡ä»¶**: `modules/local_map/overlay_window.py` (380è¡Œ)
- **å¤‡ä»½**: `modules/local_map/overlay_window_old.py` (530è¡Œ)
- **æ–‡æ¡£**: `docs/OVERLAY_REFACTOR.md`

## æ€»ç»“

é€šè¿‡å¤ç”¨MapCanvasï¼Œæˆ‘ä»¬ï¼š
- ğŸš€ **è§£å†³äº†æ€§èƒ½é—®é¢˜** - ä¸å†å¡é¡¿
- ğŸ“‰ **å‡å°‘äº†ä»£ç é‡** - 150è¡Œ
- ğŸ”§ **ç®€åŒ–äº†ç»´æŠ¤** - å•ä¸€æ¸²æŸ“é€»è¾‘
- âœ… **ä¿è¯äº†ä¸€è‡´æ€§** - å®Œå…¨ç›¸åŒçš„è¡Œä¸º

**è¿™æ‰æ˜¯æ­£ç¡®çš„åšæ³•** - ä¸è¦é‡å¤é€ è½®å­ï¼Œå¤ç”¨å·²æœ‰çš„ä¼˜ç§€å®ç°ã€‚
