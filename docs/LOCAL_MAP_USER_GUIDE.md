# 本地地图模块 - 使用指南

## 📋 目录

1. [功能介绍](#功能介绍)
2. [快速开始](#快速开始)
3. [地图导入](#地图导入)
4. [校准系统](#校准系统)
5. [多层地图配置](#多层地图配置)
6. [常见问题](#常见问题)

---

## 功能介绍

本地地图模块提供以下功能：
- ✅ **地图可视化** - 导入自定义地图图片
- ✅ **实时位置追踪** - 自动解析游戏截图显示位置
- ✅ **多层楼支持** - 支持多楼层建筑的不同楼层
- ✅ **坐标校准** - 精确映射游戏坐标到地图图片
- ✅ **缩放和平移** - 流畅的地图浏览体验

---

## 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

**必需的依赖包：**
- `customtkinter` - GUI框架
- `Pillow` - 图像处理
- `numpy` - 数值计算（坐标变换）
- `watchdog` - 文件监控（截图检测）

### 2. 启动程序

```bash
python main.py
```

### 3. 切换到本地地图Tab

在主界面点击"地图"标签页。

---

## 地图导入

### 第一步：准备地图图片

1. **获取地图图片**
   - 从网络下载高质量地图（推荐：[Tarkov.dev](https://tarkov.dev)）
   - 或使用游戏内地图截图
   - 支持格式：PNG、JPG、JPEG、BMP

2. **图片要求**
   - 清晰度：推荐至少1920x1080
   - 方向：正北朝上（标准地图方向）
   - 完整性：包含完整的游戏区域

### 第二步：导入地图

1. **选择地图**
   - 在左侧面板"选择地图"下拉框中选择目标地图
   - 例如：`Customs (bigmap)`

2. **点击"导入地图图片"**
   - 选择准备好的图片文件
   - 在弹出对话框中配置层级信息

3. **配置层级信息**
   ```
   层级ID: 0          (地面层用0，楼上用正数，地下用负数)
   层级名称: Ground Floor  (例如："1F"、"2F"、"B1")
   最小高度: -10.0     (该层的最低Y坐标)
   最大高度: 5.0       (该层的最高Y坐标)
   ```

4. **确认导入**
   - 地图将显示在右侧Canvas上
   - 可以用鼠标拖拽平移，滚轮缩放

---

## 校准系统

**为什么需要校准？**
游戏内坐标系和地图图片坐标系不同，需要通过校准建立映射关系。

### 校准流程（至少需要3个点）

#### 1. 启用校准模式

- 勾选左侧面板的"校准模式"开关
- 状态栏显示：`校准模式: 在游戏中截图，然后在地图上点击对应位置`

#### 2. 在游戏中选择已知位置

选择地图上容易辨认的标志性位置，例如：
- 建筑物角落
- 十字路口中心
- 特殊地标（雕像、标志牌等）

#### 3. 在游戏中截图

- 站在选定位置
- 按默认截图键（通常是PrintScreen）
- 软件自动检测新截图并提取坐标

**截图文件位置：**
```
%USERPROFILE%\Documents\Escape From Tarkov\Screenshots\
```

#### 4. 在地图上点击对应位置

- 检测到截图后，状态栏会显示游戏坐标
- 在地图图片上点击你刚才截图的位置
- 软件会添加一个红色标记点，标注为"P1"

#### 5. 重复步骤2-4

- 至少需要**3个校准点**
- 推荐**4-5个点**以提高精度
- 点应该分散分布在地图不同区域

#### 6. 完成校准

- 添加3个点后会弹出提示："已添加3个校准点！"
- 关闭校准模式开关
- 校准数据自动保存到`map_config.json`

### 校准质量验证

软件会自动计算校准精度：
```
仿射变换拟合完成:
  缩放: X=2.1234, Z=2.0987
  旋转: 3.45°
  平移: X=512.34, Z=768.12
  平均误差: 5.23 像素      ← 越小越好
```

**误差标准：**
- ✅ < 5像素：优秀
- ⚠️ 5-10像素：良好
- ❌ > 10像素：建议重新校准

---

## 多层地图配置

### 什么是多层地图？

对于有多个楼层的建筑（例如Interchange商场），每层需要单独的地图图片和校准。

### 配置多层地图

#### 1. 为每层导入地图图片

**示例：Interchange商场**

**地面层（Layer 0）：**
```
层级ID: 0
层级名称: Ground Floor
最小高度: -5.0
最大高度: 5.0
```

**一楼（Layer 1）：**
```
层级ID: 1
层级名称: 1st Floor
最小高度: 5.0
最大高度: 10.0
```

**二楼（Layer 2）：**
```
层级ID: 2
层级名称: 2nd Floor
最小高度: 10.0
最大高度: 15.0
```

#### 2. 确定高度范围

**方法A：通过截图测试**
1. 在游戏中站在该楼层
2. 截图查看Y坐标（状态栏会显示）
3. 在不同位置多截几张，确定最小/最大值

**方法B：经验估算**
- 塔科夫中每层楼高度通常为3-5米
- 地面层通常在Y=0附近
- 向上每层+5米，向下每层-5米

#### 3. 为每层单独校准

- 切换到对应层级
- 在游戏中进入该楼层
- 重复[校准流程](#校准流程)
- 每层至少3个校准点

#### 4. 自动楼层匹配

校准完成后，软件会根据截图的Y坐标自动选择对应楼层：
```python
if 5.0 <= player_y < 10.0:
    显示一楼地图
elif 10.0 <= player_y < 15.0:
    显示二楼地图
```

---

## 实时位置追踪

**完成校准后，可以启用位置追踪功能自动显示玩家位置**

### 启用位置追踪

1. **确认已完成校准**
   - 至少添加3个校准点
   - 状态栏显示"已校准，可启用位置追踪"

2. **开启位置追踪开关**
   - 在左侧面板找到"位置追踪"区域
   - 勾选"启用位置追踪"开关
   - 状态栏显示"位置追踪已启用"

3. **在游戏中截图**
   - 按截图键（通常是PrintScreen）
   - 软件自动检测新截图
   - 地图上自动显示你的位置和朝向

### 位置标记说明

- **绿色圆圈** - 你的当前位置
- **绿色箭头** - 你的朝向方向
- **状态栏信息** - 显示坐标、高度、朝向角度

### 多楼层自动切换

如果地图配置了多个楼层：
- 软件会根据截图的Y坐标自动匹配楼层
- 自动切换到对应楼层的地图
- 在正确的楼层地图上显示位置

**示例**：
```
在Interchange商场：
- 1楼截图 (Y=2.5) → 显示在1楼地图
- 2楼截图 (Y=7.8) → 自动切换到2楼地图
```

---

## 视图控制

### 鼠标操作

- **左键拖拽** - 平移地图
- **滚轮** - 缩放地图
- **点击** - 校准模式下添加校准点

### UI控制

- **缩放滑块** - 手动调整缩放比例（0.1x - 3.0x）
- **重置视图** - 恢复到默认视图状态

---

## 常见问题

### Q1: 截图检测不工作

**可能原因：**
1. 截图文件夹不存在
2. 游戏从未运行过

**解决方法：**
1. 确认路径：`%USERPROFILE%\Documents\Escape From Tarkov\Screenshots\`
2. 进入游戏截一张图，创建文件夹
3. 重新启用校准模式

---

### Q2: 校准误差很大（>10像素）

**可能原因：**
1. 校准点标注不准确
2. 地图图片方向不对
3. 校准点分布过于集中

**解决方法：**
1. **清除校准点** - 点击"清除校准点"按钮
2. **重新选点** - 选择明显的标志性位置
3. **精确点击** - 放大地图后再点击
4. **分散分布** - 点应该分布在地图四个角落

---

### Q3: 多层建筑自动匹配错误楼层

**可能原因：**
高度范围配置重叠或错误

**解决方法：**
1. 点击"配置层级高度"
2. 检查每层的height_min和height_max
3. 确保各层高度范围不重叠：
   ```
   Layer 0: -5.0 到 5.0   ✓
   Layer 1: 5.0 到 10.0   ✓
   Layer 2: 10.0 到 15.0  ✓

   错误示例：
   Layer 0: 0 到 10.0     ✗
   Layer 1: 5.0 到 15.0   ✗  (重叠区域)
   ```

---

### Q4: 地图图片显示不完整

**可能原因：**
图片分辨率过高

**解决方法：**
1. 使用图片编辑软件（如Paint.NET）
2. 调整图片大小到1920x1080或2560x1440
3. 重新导入地图

---

### Q5: 如何获取高质量地图图片？

**推荐资源：**
1. **Tarkov.dev** - https://tarkov.dev/maps
   - 官方支持的社区地图
   - 高质量PNG格式
   - 实时更新

2. **Tarkov Wiki** - https://escapefromtarkov.fandom.com/wiki/Maps
   - 详细的交互式地图
   - 可截图使用

3. **MapGenie** - https://mapgenie.io/tarkov
   - 交互式地图平台
   - 支持导出高分辨率图片

---

## 配置文件

### map_config.json

校准数据保存在项目根目录的`map_config.json`文件中：

```json
{
  "maps": {
    "bigmap": {
      "map_id": "bigmap",
      "display_name": "Customs",
      "default_layer_id": 0,
      "layers": [
        {
          "layer_id": 0,
          "name": "Ground Floor",
          "image_path": "D:/maps/customs.png",
          "height_min": -10.0,
          "height_max": 5.0,
          "calibration_points": [
            {
              "game_pos": {"x": 123.45, "y": 0.0, "z": -10.23},
              "map_x": 512.0,
              "map_y": 768.0,
              "timestamp": "2024-12-05T14:32:00"
            }
          ]
        }
      ]
    }
  }
}
```

### 备份配置

定期备份`map_config.json`文件，避免丢失校准数据。

---

## 下一步功能（即将实现）

- ✅ **实时位置追踪** - 已实现！自动显示玩家当前位置和朝向
- 🗺️ **浮动小地图** - 游戏内覆盖的小地图窗口（计划中）
- 🌍 **服务器IP显示** - 显示战局服务器地理位置（计划中）
- 📍 **标记系统** - 添加自定义标记点（计划中）
- 🔄 **自动楼层切换** - 根据高度自动切换地图层级（计划中）

---

## 技术支持

遇到问题？
1. 查看控制台输出的错误信息
2. 检查`map_config.json`文件格式
3. 确认所有依赖包已正确安装

**日志位置：** 控制台输出（运行`python main.py`的窗口）
